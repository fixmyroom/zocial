<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>FixMyRoom ðŸ‘‘ Admin Dashboard</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="img/logo.png" type="image/png" />
  <meta name="theme-color" content="#000" />
  <style>
    body, html {
      margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #000;
      color: #eee;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: #111;
      padding: 15px 20px;
      font-size: 1.6rem;
      font-weight: 700;
      color: #28a745;
      box-shadow: 0 2px 8px rgba(0,0,0,0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    header button {
      background: #28a745;
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    header button:hover {
      background: #1db954;
    }

    main {
      flex: 1;
      padding: 15px 20px;
      overflow-y: auto;
    }

    section {
      margin-bottom: 30px;
    }

    h2 {
      color: #28a745;
      font-weight: 700;
      margin-bottom: 12px;
      font-size: 1.5rem;
    }

    /* Stats summary */
    .stats {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .stat-card {
      flex: 1 1 150px;
      background: #111;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 0 10px #28a745;
      font-weight: 700;
      font-size: 1.3rem;
    }

    /* User list */
    .user-list {
      background: #111;
      border-radius: 15px;
      padding: 15px;
      max-height: 320px;
      overflow-y: auto;
      box-shadow: 0 0 10px #28a745;
    }

    .user-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #28a74544;
      padding: 8px 0;
    }

    .user-item:last-child {
      border-bottom: none;
    }

    .user-info {
      font-size: 1rem;
      color: #ddd;
      flex: 1;
      user-select: text;
    }

    .role-select {
      background: #222;
      border: 1px solid #28a745;
      color: #eee;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 1rem;
      cursor: pointer;
      outline: none;
      user-select: none;
    }

    /* Orders list */
    .order-list {
      background: #111;
      border-radius: 15px;
      padding: 15px;
      max-height: 320px;
      overflow-y: auto;
      box-shadow: 0 0 10px #28a745;
    }

    .order-item {
      border-bottom: 1px solid #28a74544;
      padding: 10px 0;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .order-id {
      font-weight: 700;
      color: #28a745;
    }

    .order-status {
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 12px;
      color: white;
      font-size: 0.9rem;
      user-select: none;
    }

    .status-pending {
      background-color: #aaa;
    }

    .status-accepted {
      background-color: #28a745;
    }

    .status-rejected {
      background-color: #d33;
    }

    .status-completed {
      background-color: #007bff;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .stats {
        flex-direction: column;
      }
      .stat-card {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    Admin Dashboard
    <button id="logoutBtn" title="Logout">Logout</button>
  </header>

  <main>
    <section aria-label="Statistics summary">
      <h2>Statistics</h2>
      <div class="stats">
        <div class="stat-card" id="totalUsers">Users: 0</div>
        <div class="stat-card" id="totalOrders">Orders: 0</div>
      </div>
    </section>

    <section aria-label="User management">
      <h2>Users</h2>
      <div class="user-list" id="userList">
        Loading users...
      </div>
    </section>

    <section aria-label="Order management">
      <h2>Orders</h2>
      <div class="order-list" id="orderList">
        Loading orders...
      </div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js';
    import {
      getFirestore, collection, onSnapshot, updateDoc, doc, getDoc
    } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAB5KK4gMMwCAzmxjzTRAd0gK-gzpzbzmw",
      authDomain: "fixmyroomwithzocial.firebaseapp.com",
      projectId: "fixmyroomwithzocial",
      storageBucket: "fixmyroomwithzocial.firebasestorage.app",
      messagingSenderId: "594671909340",
      appId: "1:594671909340:web:9a9feedefed205a50ef719"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const logoutBtn = document.getElementById('logoutBtn');
    const userListEl = document.getElementById('userList');
    const orderListEl = document.getElementById('orderList');
    const totalUsersEl = document.getElementById('totalUsers');
    const totalOrdersEl = document.getElementById('totalOrders');

    logoutBtn.addEventListener('click', () => {
      signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      if (!userDoc.exists() || userDoc.data().role !== 'admin') {
        alert('Access denied: Admins only');
        window.location.href = 'index.html';
        return;
      }
      loadUsers();
      loadOrders();
    });

    function renderUser(userDoc) {
      const data = userDoc.data();
      const uid = userDoc.id;

      const container = document.createElement('div');
      container.className = 'user-item';

      const info = document.createElement('div');
      info.className = 'user-info';
      info.textContent = `${data.name || 'No Name'} (${data.email || 'No Email'})`;

      const select = document.createElement('select');
      select.className = 'role-select';
      select.setAttribute('aria-label', `Change role for user ${data.name || uid}`);
      ['customer', 'worker', 'store', 'admin'].forEach(role => {
        const option = document.createElement('option');
        option.value = role;
        option.textContent = role.charAt(0).toUpperCase() + role.slice(1);
        if (role === data.role) option.selected = true;
        select.appendChild(option);
      });

      select.addEventListener('change', async () => {
        try {
          await updateDoc(doc(db, 'users', uid), { role: select.value });
          alert(`Role updated to ${select.value}`);
        } catch (e) {
          alert('Failed to update role: ' + e.message);
          // revert select value
          select.value = data.role;
        }
      });

      container.appendChild(info);
      container.appendChild(select);

      return container;
    }

    function renderOrder(orderDoc) {
      const data = orderDoc.data();
      const id = orderDoc.id;
      const statusClass = {
        pending: 'status-pending',
        accepted: 'status-accepted',
        rejected: 'status-rejected',
        completed: 'status-completed'
      }[data.status] || 'status-pending';

      const container = document.createElement('div');
      container.className = 'order-item';

      container.innerHTML = `
        <div><span class="order-id">Order #${id.slice(0,6).toUpperCase()}</span> - <span class="order-status ${statusClass}">${(data.status || 'pending').toUpperCase()}</span></div>
        <div>Customer: ${data.customerName || 'Unknown'}</div>
        <div>Store: ${data.storeName || 'Unknown'}</div>
        <div>Description: ${data.description || 'No description'}</div>
      `;

      return container;
    }

    function loadUsers() {
      const usersCol = collection(db, 'users');
      onSnapshot(usersCol, (snapshot) => {
        if (snapshot.empty) {
          userListEl.textContent = 'No users found.';
          totalUsersEl.textContent = 'Users: 0';
          return;
        }
        userListEl.innerHTML = '';
        totalUsersEl.textContent = `Users: ${snapshot.size}`;
        snapshot.forEach(docSnap => {
          const userEl = renderUser(docSnap);
          userListEl.appendChild(userEl);
        });
      });
    }

    function loadOrders() {
      const ordersCol = collection(db, 'storeOrders');
      onSnapshot(ordersCol, (snapshot) => {
        if (snapshot.empty) {
          orderListEl.textContent = 'No orders found.';
          totalOrdersEl.textContent = 'Orders: 0';
          return;
        }
        orderListEl.innerHTML = '';
        totalOrdersEl.textContent = `Orders: ${snapshot.size}`;
        snapshot.forEach(docSnap => {
          const orderEl = renderOrder(docSnap);
          orderListEl.appendChild(orderEl);
        });
      });
    }
  </script>
</body>
</html>
