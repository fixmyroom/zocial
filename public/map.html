<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>FixMyRoom üó∫Ô∏è Map</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="img/logo.png" type="image/png" />
  <meta name="theme-color" content="#000" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-sA+4DcCGd+Ej0j3gsQJp8vxg9wUENp4xmZZM5vQf1R0="
    crossorigin=""
  />

  <style>
    /* Reset & basics */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #000;
      color: #eee;
      -webkit-tap-highlight-color: transparent;
      overflow: hidden;
    }

    #map {
      height: 100vh;
      width: 100vw;
      z-index: 1;
    }

    /* Top bar with filters */
    #topbar {
      position: fixed;
      top: 0; left: 0; right: 0;
      background: #111;
      padding: 10px 12px;
      display: flex;
      justify-content: center;
      gap: 12px;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0,0,0,0.8);
    }

    #topbar select, #topbar button {
      background: #222;
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      color: #eee;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      min-width: 120px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.6);
      transition: background 0.3s ease;
      user-select: none;
    }

    #topbar select:focus, #topbar button:focus {
      outline: none;
      background: #28a745;
      color: #fff;
      box-shadow: 0 0 15px #28a745;
    }

    #topbar button:hover {
      background: #28a745;
      box-shadow: 0 0 15px #28a745;
    }

    /* Request Modal */
    #requestModal {
      position: fixed;
      top: 0; left: 0; right:0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      padding: 20px;
    }

    #requestModal.active {
      display: flex;
    }

    #requestForm {
      background: #111;
      padding: 20px 25px;
      border-radius: 12px;
      width: 100%;
      max-width: 400px;
      box-shadow: 0 0 15px #28a745;
      color: #eee;
    }

    #requestForm h2 {
      margin-top: 0;
      margin-bottom: 15px;
      font-weight: 700;
      font-size: 1.6rem;
      color: #28a745;
      text-align: center;
    }

    #requestForm label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 1rem;
    }

    #requestForm input,
    #requestForm textarea,
    #requestForm select {
      width: 100%;
      padding: 12px 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      background: #222;
      color: #eee;
      resize: none;
    }

    #requestForm textarea {
      height: 80px;
    }

    #requestForm button {
      background: #28a745;
      border: none;
      border-radius: 12px;
      padding: 14px;
      width: 100%;
      font-size: 1.2rem;
      font-weight: 700;
      color: white;
      cursor: pointer;
      box-shadow: 0 0 12px #28a745;
      transition: background 0.3s ease;
    }

    #requestForm button:hover {
      background: #1db954;
    }

    #requestClose {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 2rem;
      color: #28a745;
      cursor: pointer;
      user-select: none;
    }

    /* Floating social buttons */
    .floating-icons {
      position: fixed;
      bottom: 30px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      z-index: 3000;
    }

    .floating-icons a {
      background: #25d366;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 28px;
      text-decoration: none;
      transition: background 0.3s ease;
      user-select: none;
    }

    .floating-icons a.facebook {
      background: #1877f2;
    }

    .floating-icons a:hover {
      filter: brightness(1.2);
      box-shadow: 0 0 15px #28a745;
    }

    /* Phone call button inside popup */
    .call-btn {
      display: inline-block;
      margin-left: 8px;
      background: #28a745;
      color: white;
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      text-decoration: none;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <select id="roleFilter" title="Filter by Role">
      <option value="all">üîé Show All</option>
      <option value="painter">üñåÔ∏è Painter</option>
      <option value="plumber">üö∞ Plumber</option>
      <option value="electrician">‚ö° Electrician</option>
      <option value="store">üè¨ Store</option>
    </select>
    <button id="refreshBtn" title="Refresh Locations">üîÑ Refresh</button>
    <button id="logoutBtn" title="Logout">üö™ Logout</button>
  </div>

  <div id="map"></div>

  <!-- Request Modal -->
  <div id="requestModal" role="dialog" aria-modal="true" aria-labelledby="requestTitle">
    <div id="requestForm">
      <span id="requestClose" title="Close">&times;</span>
      <h2 id="requestTitle">Request Service üõ†Ô∏è</h2>
      <form id="serviceRequestForm">
        <label for="serviceType">Service Type</label>
        <select id="serviceType" required>
          <option value="" disabled selected>Select role</option>
          <option value="painter">üñåÔ∏è Painter</option>
          <option value="plumber">üö∞ Plumber</option>
          <option value="electrician">‚ö° Electrician</option>
        </select>

        <label for="description">Description</label>
        <textarea id="description" placeholder="Describe your issue or request..." required></textarea>

        <button type="submit">Send Request üöÄ</button>
      </form>
    </div>
  </div>

  <!-- Floating social -->
  <div class="floating-icons" aria-label="Social contacts">
    <a href="https://wa.me/9779851151294" target="_blank" aria-label="WhatsApp chat" class="whatsapp">üí¨</a>
    <a href="https://www.facebook.com/people/ZocialPainter/61578207554465/" target="_blank" aria-label="Facebook page" class="facebook">üìò</a>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-oZnd6LvEjf6U1PTSe5XK0S8a5AwHnS3sIlWvZyy+qCo="
    crossorigin=""
  ></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js';
    import {
      getFirestore, collection, doc, getDoc, onSnapshot, query, where, addDoc, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAB5KK4gMMwCAzmxjzTRAd0gK-gzpzbzmw",
      authDomain: "fixmyroomwithzocial.firebaseapp.com",
      projectId: "fixmyroomwithzocial",
      storageBucket: "fixmyroomwithzocial.firebasestorage.app",
      messagingSenderId: "594671909340",
      appId: "1:594671909340:web:9a9feedefed205a50ef719"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Globals
    let currentUser = null;
    let userRole = null;
    let map, userMarker;
    let markersLayer;
    let workersMarkers = {};
    let storesMarkers = {};
    let requestsMarkers = {};

    const roleFilter = document.getElementById('roleFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const requestModal = document.getElementById('requestModal');
    const requestClose = document.getElementById('requestClose');
    const serviceRequestForm = document.getElementById('serviceRequestForm');

    // Initialize map
    function initMap(lat = 27.7, lng = 85.3) {
      map = L.map('map', {
        center: [lat, lng],
        zoom: 13,
        zoomControl: true,
      });

      // Tile layer - dark style
      L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        {
          attribution:
            '&copy; <a href="https://carto.com/attributions">CARTO</a>',
          maxZoom: 19,
        }
      ).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
    }

    // Add or update marker for a user on map
    function addOrUpdateMarker(collectionType, id, data) {
      const { latitude, longitude, name, role } = data;
      if (!latitude || !longitude) return;

      let iconColor;
      if (role === 'painter') iconColor = 'üñåÔ∏è';
      else if (role === 'plumber') iconColor = 'üö∞';
      else if (role === 'electrician') iconColor = '‚ö°';
      else if (role === 'store') iconColor = 'üè¨';
      else iconColor = '‚ùì';

      const markerIcon = L.divIcon({
        className: 'custom-div-icon',
        html: `<div style="font-size: 1.8rem; text-align:center;">${iconColor}</div>`,
        iconSize: [30, 42],
        iconAnchor: [15, 42],
      });

      // Remove old marker if exists
      if (collectionType === 'workers') {
        if (workersMarkers[id]) {
          map.removeLayer(workersMarkers[id]);
        }
        workersMarkers[id] = L.marker([latitude, longitude], { icon: markerIcon })
          .bindPopup(`<b>${name || role}</b><br>Role: ${role}`)
          .addTo(markersLayer);
      } else if (collectionType === 'stores') {
        if (storesMarkers[id]) {
          map.removeLayer(storesMarkers[id]);
        }
        storesMarkers[id] = L.marker([latitude, longitude], { icon: markerIcon })
          .bindPopup(`<b>${name || 'Store'}</b>`)
          .addTo(markersLayer);
      } else if (collectionType === 'requests') {
        if (requestsMarkers[id]) {
          map.removeLayer(requestsMarkers[id]);
        }
        requestsMarkers[id] = L.marker([latitude, longitude], { icon: markerIcon, riseOnHover: true })
          .bindPopup(`<b>Request</b><br>Service: ${role}<br>Description: ${data.description || ''}<br><small>By ${data.requesterName || 'User'}</small>`)
          .addTo(markersLayer);
      }
    }

    // Clear all markers from map and reset marker objects
    function clearMarkers() {
      markersLayer.clearLayers();
      Object.keys(workersMarkers).forEach(k => delete workersMarkers[k]);
      Object.keys(storesMarkers).forEach(k => delete storesMarkers[k]);
      Object.keys(requestsMarkers).forEach(k => delete requestsMarkers[k]);
    }

    // Load data and place markers based on role and filter
    async function loadMarkers() {
      clearMarkers();

      const filterRole = roleFilter.value;
      const workersCol = collection(db, 'users');
      const storesCol = collection(db, 'stores');
      const requestsCol = collection(db, 'requests');

      // Load stores if filter is all or store
      if (filterRole === 'all' || filterRole === 'store') {
        const storesSnap = await getDocs(storesCol);
        storesSnap.forEach(docSnap => {
          const data = docSnap.data();
          addOrUpdateMarker('stores', docSnap.id, data);
        });
      }

      // Load workers if filter includes their role or all
      if (filterRole === 'all' || ['painter', 'plumber', 'electrician'].includes(filterRole)) {
        const q = filterRole === 'all' ? query(workersCol, where('role', 'in', ['painter', 'plumber', 'electrician'])) : query(workersCol, where('role', '==', filterRole));
        const workersSnap = await getDocs(q);
        workersSnap.forEach(docSnap => {
          const data = docSnap.data();
          addOrUpdateMarker('workers', docSnap.id, data);
        });
      }

      // Show requests only for customers or admins
      if (userRole === 'customer' || userRole === 'admin') {
        const requestsSnap = await getDocs(requestsCol);
        requestsSnap.forEach(docSnap => {
          const data = docSnap.data();
          addOrUpdateMarker('requests', docSnap.id, data);
        });
      }
    }

    // Request Service Modal controls
    function openRequestModal() {
      requestModal.classList.add('active');
    }
    function closeRequestModal() {
      requestModal.classList.remove('active');
    }

    requestClose.addEventListener('click', closeRequestModal);
    requestModal.addEventListener('click', e => {
      if (e.target === requestModal) closeRequestModal();
    });

    // Submit new service request
    serviceRequestForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const serviceType = document.getElementById('serviceType').value;
      const description = document.getElementById('description').value.trim();

      if (!serviceType || !description) {
        alert('Please select service type and enter description.');
        return;
      }

      try {
        await addDoc(collection(db, 'requests'), {
          requesterId: currentUser.uid,
          requesterName: currentUser.email,
          role: serviceType,
          description,
          location: userMarker ? {
            latitude: userMarker.getLatLng().lat,
            longitude: userMarker.getLatLng().lng
          } : null,
          createdAt: serverTimestamp(),
          status: 'pending'
        });

        alert('Request sent successfully!');
        closeRequestModal();
        serviceRequestForm.reset();
      } catch (err) {
        alert('Failed to send request: ' + err.message);
      }
    });

    // Logout button
    logoutBtn.addEventListener('click', () => {
      signOut(auth);
    });

    // Refresh button
    refreshBtn.addEventListener('click', () => {
      loadMarkers();
      alert('Map data refreshed');
    });

    // Role filter change
    roleFilter.addEventListener('change', loadMarkers);

    // Detect user location, place marker, init map
    function onLocationFound(e) {
      const radius = e.accuracy / 2;

      if (userMarker) {
        userMarker.setLatLng(e.latlng);
      } else {
        userMarker = L.marker(e.latlng, {
          draggable: true,
          title: "Your location (drag to adjust)"
        }).addTo(map).bindPopup("You are here. Drag marker to adjust location.").openPopup();

        userMarker.on('dragend', () => {
          alert('Location updated!');
        });
      }

      // Circle accuracy (optional)
      /*
      L.circle(e.latlng, radius).addTo(map);
      */
    }

    function onLocationError(e) {
      alert('Location not found. Default location will be used.');
    }

    // Check user role and permissions, setup UI accordingly
    async function setupUI(user) {
      currentUser = user;

      // Fetch user document for role
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      if (!userDoc.exists()) {
        alert('User profile not found. Redirecting to profile setup...');
        window.location.href = 'profile.html';
        return;
      }

      const data = userDoc.data();
      userRole = data.role;

      // Init map and location
      initMap();

      // Show/hide role filter and request button based on role
      if (userRole === 'customer') {
        roleFilter.style.display = 'inline-block';
        addRequestButton();
      } else {
        roleFilter.style.display = 'none';
      }

      // Load markers initially
      loadMarkers();

      // Locate user
      map.locate({ setView: true, maxZoom: 16, watch: true });
      map.on('locationfound', onLocationFound);
      map.on('locationerror', onLocationError);
    }

    // Add request service button for customers
    function addRequestButton() {
      if (document.getElementById('requestServiceBtn')) return; // already added

      const btn = document.createElement('button');
      btn.id = 'requestServiceBtn';
      btn.textContent = 'üõ†Ô∏è Request Service';
      btn.style.position = 'fixed';
      btn.style.bottom = '100px';
      btn.style.right = '20px';
      btn.style.padding = '14px 22px';
      btn.style.fontSize = '1.3rem';
      btn.style.borderRadius = '20px';
      btn.style.border = 'none';
      btn.style.backgroundColor = '#28a745';
      btn.style.color = 'white';
      btn.style.cursor = 'pointer';
      btn.style.zIndex = '1500';
      btn.style.boxShadow = '0 0 15px #28a745';
      btn.style.userSelect = 'none';

      btn.addEventListener('click', openRequestModal);

      document.body.appendChild(btn);
    }

    // Auth listener
    onAuthStateChanged(auth, (user) => {
      if (user) {
        setupUI(user);
      } else {
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
